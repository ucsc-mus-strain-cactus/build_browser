"""
Produces trackDb files for the Augustus tracks generated by Mario.
"""

import sys
import os
import argparse

def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('--assembly_version', help='genome assembly version (1504, etc)', required=True)
    parser.add_argument('--ref_genome', help='reference genome', required=True)
    parser.add_argument('--genome', help='genome', required=True)
    return parser.parse_args()

searchtmr = """
# search by ensembl id
searchName augustusTMR_ens_id
searchTable augustusTMR
searchMethod prefix
searchType genePred
termRegex ENSMUST[0-9.]+
query select chrom, txStart, txEnd, name from %s where name2 like '%s%%'

# search by gene name
searchName augustusTMR_geneName
searchTable augustusTMR
searchMethod prefix
searchType genePred
query select chrom, txStart, txEnd, name from %s where name2 like '%s'
xrefTable MusC57B6J_1509.wgEncodeGencodeAttrsVM7
xrefQuery select transcriptId,geneName from %s where geneName like '%s%%'

# search by augustus ID
searchName augustusTMR
searchTable augustusTMR
searchMethod prefix
searchType genePred
termRegex aug-([0-9]+-|)ENSMUST[0-9.]+-[0-9]+

"""

searchcgp = """# search by CGP id
searchName augustusCGP
searchTable augustusCGP
searchMethod prefix
searchType genePred
termRegex g[0-9]+.t[0-9]+

"""


searchcgp_unfiltered = """# search by CGP id
searchName augustusCGP_unfiltered
searchTable augustusCGP_unfiltered
searchMethod prefix
searchType genePred
termRegex g[0-9]+.t[0-9]+

"""


supertrack = """track augustus
superTrack on show
shortLabel AUGUSTUS
longLabel AUGUSTUS gene predictions
group genes
html /hive/groups/recon/projs/mus_strain_cactus/pipeline_data/comparative/1504/augustus/augustus.html

"""


tmr = """    track augustusTMR
    superTrack augustus pack
    shortLabel AUGUSTUS using TransMap and RNA-Seq
    longLabel AUGUSTUS using TransMap coding genes and RNA-Seq
    group genes
    type genePred
    priority 1.0
    color 255,0,0
    visibility pack

"""

cgp = """    track augustusCGP
    superTrack augustus pack
    shortLabel comparative AUGUSTUS
    longLabel comparative AUGUSTUS
    group genes
    type genePred
    priority 1.0
    color 100,150,250
    visibility pack

"""


cgp_unfiltered = """    track augustusCGP_unfiltered
    superTrack augustus pack
    shortLabel comparative AUGUSTUS (unfiltered)
    longLabel comparative AUGUSTUS (unfiltered)
    group genes
    type genePred
    priority 1.0
    color 100,150,250
    visibility pack

"""



def make_cgp_tracks(file_handle):
    file_handle.write(supertrack)
    file_handle.write(cgp)
    file_handle.write(searchcgp)
    file_handle.write(cgp_unfiltered)
    file_handle.write(searchcgp_unfiltered)


def make_tmr_tracks(file_handle):
    file_handle.write(tmr)
    file_handle.write(searchtmr)

def main():
    args = parse_args()
    if args.assembly_version != "1509":
        print "This script was called on a release that was not 1509 or not on the reference. Did nothing."
        sys.exit(1)
    target_file_template = "trackDb/{0}/Mus{0}_{1}/augustus.trackDb.ra"
    target_file = target_file_template.format(args.genome, args.assembly_version)
    if args.genome == args.ref_genome or args.genome == "Rattus":
        with open(target_file, "w") as outf:
            make_cgp_tracks(outf)
    else:
        with open(target_file, "w") as outf:
            make_cgp_tracks(outf)
            make_tmr_tracks(outf)


if __name__ == "__main__":
    main()
